<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mineiro - Gerenciar Funcion√°rios na Nuvem</title>
    <!-- Incluindo Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura√ß√£o da fonte Inter (opcional, mas boa pr√°tica) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilos para o modal de mensagem */
        .modal {
            display: none; /* Escondido por padr√£o */
            position: fixed; /* Fica por cima de tudo */
            z-index: 1000; /* Alto z-index para garantir que fique na frente */
            left: 0;
            top: 0;
            width: 100%; /* Largura total */
            height: 100%; /* Altura total */
            overflow: auto; /* Habilita rolagem se o conte√∫do for muito grande */
            background-color: rgba(0,0,0,0.4); /* Fundo semi-transparente */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .modal-content h3 {
            margin-top: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .modal-content p {
            margin-bottom: 20px;
            font-size: 1rem;
            color: #4a5568;
        }
        .modal-buttons button {
            @apply px-4 py-2 rounded-lg text-white font-medium transition-colors duration-200;
        }
        .modal-buttons .confirm-button {
            @apply bg-blue-500 hover:bg-blue-600 mr-2;
        }
        .modal-buttons .cancel-button {
            @apply bg-gray-400 hover:bg-gray-500;
        }
        .modal-buttons .ok-button {
            @apply bg-green-500 hover:bg-green-600;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8 flex flex-col items-center min-h-screen">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center leading-tight">
        Funcion√°rios em Nuvem <span class="text-blue-600">‚òÅÔ∏èüòé</span>
    </h1>

    <!-- Exibi√ß√£o do User ID para debugging e m√∫ltiplos usu√°rios -->
    <div id="userIdDisplay" class="text-sm text-gray-600 mb-4 text-center break-all">
        ID do Usu√°rio: Carregando...
    </div>
    
    <div class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-lg mb-6">
        <h3 id="formTitle" class="text-xl font-semibold text-gray-700 mb-4">Adicionar Funcion√°rio</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <input type="text" id="employeeName" placeholder="Nome do funcion√°rio" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none">
            <input type="text" id="employeeId" placeholder="Matr√≠cula" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none">
            <select id="employeeRole" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer">
                <option value="" disabled selected>Selecione o cargo</option>
                <option value="Coletor">Coletor</option>
                <option value="Gari">Gari</option>
                <option value="Motorista">Motorista</option>
            </select>
            <select id="employeeStatus" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer">
                <option value="ativo" selected>Ativo</option>
                <option value="inativo">Inativo</option>
            </select>
        </div>
        <button id="formButton" onclick="saveEmployee()" class="mt-5 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-md">Salvar na Nuvem</button>
        <button id="cancelEditButton" style="display: none;" onclick="cancelEdit()" class="mt-3 w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-md">Cancelar</button>
    </div>
    
    <div class="w-full max-w-2xl bg-white p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Procurar Funcion√°rio</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <input type="text" id="searchInput" placeholder="Nome, matr√≠cula ou cargo" onkeyup="searchEmployees()" class="md:col-span-3 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none">
            <select id="roleFilter" onchange="filterByRole()" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer">
                <option value="">Todos os Cargos</option>
                <option value="Coletor">Coletor</option>
                <option value="Gari">Gari</option>
                <option value="Motorista">Motorista</option>
            </select>
            <select id="statusFilter" onchange="filterByStatus()" class="p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 outline-none cursor-pointer">
                <option value="">Todos os Status</option>
                <option value="ativo">Ativos</option>
                <option value="inativo">Inativos</option>
            </select>
            <button id="listAllButton" onclick="listAllEmployees()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-md">Listar Todos</button>
        </div>
    </div>
    
    <p id="employeeCounter" class="text-lg font-semibold text-gray-700 mb-4">Total de funcion√°rios na nuvem: 0 <span class="text-blue-600">‚òÅÔ∏è</span></p>
    <ul id="employeeList" class="w-full max-w-2xl list-none p-0">
        <!-- Itens da lista de funcion√°rios ser√£o inseridos aqui -->
    </ul>

    <!-- Modal para mensagens e confirma√ß√µes -->
    <div id="appModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div id="modalButtons" class="modal-buttons">
                <!-- Bot√µes ser√£o adicionados dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK - Vers√£o modular (v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, onSnapshot, FieldValue } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let app;
        let db;
        let auth;
        let userId; // Will store the authenticated user's ID
        let authReady = false; // Flag to indicate if authentication is ready

        // State to track editing
        let editingEmployeeId = null;
        let currentEditingLi = null;

        /**
         * @function showModal
         * @description Displays a custom modal with a given title, message, and type (alert or confirm).
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display in the modal.
         * @param {'alert'|'confirm'} type - The type of modal ('alert' or 'confirm').
         * @returns {Promise<boolean>} Resolves to true if 'OK'/'Confirm' is clicked, false if 'Cancel'.
         */
        function showModal(title, message, type) {
            return new Promise((resolve) => {
                const modal = document.getElementById('appModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalMessage = document.getElementById('modalMessage');
                const modalButtons = document.getElementById('modalButtons');

                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalButtons.innerHTML = ''; // Clear existing buttons

                if (type === 'alert') {
                    const okButton = document.createElement('button');
                    okButton.textContent = 'OK';
                    okButton.className = 'ok-button';
                    okButton.onclick = () => {
                        modal.style.display = 'none';
                        resolve(true);
                    };
                    modalButtons.appendChild(okButton);
                } else if (type === 'confirm') {
                    const confirmButton = document.createElement('button');
                    confirmButton.textContent = 'Confirmar';
                    confirmButton.className = 'confirm-button';
                    confirmButton.onclick = () => {
                        modal.style.display = 'none';
                        resolve(true);
                    };

                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancelar';
                    cancelButton.className = 'cancel-button';
                    cancelButton.onclick = () => {
                        modal.style.display = 'none';
                        resolve(false);
                    };

                    modalButtons.appendChild(confirmButton);
                    modalButtons.appendChild(cancelButton);
                }

                modal.style.display = 'flex'; // Show the modal
            });
        }

        /**
         * @function checkDuplicateEmployeeId
         * @description Checks if an employee ID already exists in Firestore, excluding a specific document during edits.
         * @param {string} employeeId - The employee ID to check.
         * @param {string|null} excludeDocId - The document ID to exclude from the check (for edits).
         * @returns {Promise<boolean>} True if a duplicate is found, false otherwise.
         */
        async function checkDuplicateEmployeeId(employeeId, excludeDocId = null) {
            try {
                // Ensure auth is ready before attempting Firestore operations
                if (!authReady) {
                    console.warn("Firestore not ready. Authentication not complete.");
                    return false; // Or throw an error, depending on desired behavior
                }
                const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
                const q = query(employeesRef);
                const querySnapshot = await new Promise((resolve, reject) => {
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        unsubscribe(); // Unsubscribe after the first snapshot
                        resolve(snapshot);
                    }, reject);
                });

                if (excludeDocId) {
                    return querySnapshot.docs.some(doc => doc.id !== excludeDocId && doc.data().employeeId === employeeId);
                }
                return !querySnapshot.empty && querySnapshot.docs.some(doc => doc.data().employeeId === employeeId);
            } catch (error) {
                console.error('Erro ao verificar matr√≠cula:', error);
                await showModal('Erro', 'Opa, algo deu errado ao verificar a matr√≠cula!', 'alert');
                return false;
            }
        }

        /**
         * @function checkDuplicateEmployeeName
         * @description Checks if an employee name already exists in Firestore, excluding a specific document during edits.
         * @param {string} name - The employee name to check.
         * @param {string|null} excludeDocId - The document ID to exclude from the check (for edits).
         * @returns {Promise<boolean>} True if a duplicate is found, false otherwise.
         */
        async function checkDuplicateEmployeeName(name, excludeDocId = null) {
            try {
                // Ensure auth is ready before attempting Firestore operations
                if (!authReady) {
                    console.warn("Firestore not ready. Authentication not complete.");
                    return false;
                }
                const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
                const q = query(employeesRef);
                const querySnapshot = await new Promise((resolve, reject) => {
                    const unsubscribe = onSnapshot(q, (snapshot) => {
                        unsubscribe(); // Unsubscribe after the first snapshot
                        resolve(snapshot);
                    }, reject);
                });

                if (excludeDocId) {
                    return querySnapshot.docs.some(doc => doc.id !== excludeDocId && doc.data().name === name.toUpperCase());
                }
                return !querySnapshot.empty && querySnapshot.docs.some(doc => doc.data().name === name.toUpperCase());
            } catch (error) {
                console.error('Erro ao verificar nome:', error);
                await showModal('Erro', 'Opa, algo deu errado ao verificar o nome!', 'alert');
                return false;
            }
        }

        /**
         * @function saveEmployee
         * @description Adds a new employee or updates an existing one in Firestore.
         */
        async function saveEmployee() {
            let name = document.getElementById('employeeName').value.trim().toUpperCase();
            let employeeId = document.getElementById('employeeId').value.trim();
            let role = document.getElementById('employeeRole').value;
            let status = document.getElementById('employeeStatus').value;

            // Basic validation
            if (!name || !employeeId || !role) {
                await showModal('Campos Obrigat√≥rios', 'Preencha todos os campos, campe√£o! N√£o deixa a nuvem vazia! üòú', 'alert');
                return;
            }

            try {
                // Check for duplicate employee ID
                const isDuplicateId = await checkDuplicateEmployeeId(employeeId, editingEmployeeId);
                if (isDuplicateId) {
                    await showModal('Matr√≠cula Duplicada', 'Opa, essa matr√≠cula j√° t√° cadastrada! Tenta outra, campe√£o! üòú', 'alert');
                    return;
                }

                // Check for duplicate employee name
                const isDuplicateName = await checkDuplicateEmployeeName(name, editingEmployeeId);
                if (isDuplicateName) {
                    await showModal('Nome Duplicado', 'Opa, esse nome j√° t√° cadastrado! Tenta outro, campe√£o! üòú', 'alert');
                    return;
                }

                // Employee data object
                const employeeData = {
                    name: name,
                    employeeId: employeeId,
                    role: role,
                    status: status,
                    timestamp: FieldValue.serverTimestamp()
                };

                if (editingEmployeeId) {
                    // Update existing employee
                    const employeeDocRef = doc(db, `artifacts/${appId}/public/data/employees`, editingEmployeeId);
                    await updateDoc(employeeDocRef, employeeData);
                    await showModal('Sucesso!', 'Funcion√°rio atualizado na nuvem! T√° voando alto! üöÄ', 'alert');
                } else {
                    // Add new employee
                    await addDoc(collection(db, `artifacts/${appId}/public/data/employees`), employeeData);
                    await showModal('Sucesso!', 'Funcion√°rio salvo na nuvem! T√° voando alto! üöÄ', 'alert');
                }

                // Reset the form and reload employees
                cancelEdit();
            } catch (error) {
                console.error('Erro ao salvar:', error);
                await showModal('Erro ao Salvar', 'Opa, algo deu errado ao salvar! Erro: ' + error.message, 'alert');
            }
        }

        /**
         * @function cancelEdit
         * @description Resets the form and cancels any ongoing edit operation.
         */
        function cancelEdit() {
            editingEmployeeId = null;
            document.getElementById('formTitle').textContent = 'Adicionar Funcion√°rio';
            document.getElementById('formButton').textContent = 'Salvar na Nuvem';
            document.getElementById('cancelEditButton').style.display = 'none';
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeRole').value = '';
            document.getElementById('employeeStatus').value = 'ativo';

            // Remove highlight from any selected item
            document.querySelectorAll('#employeeList li').forEach(item => {
                item.classList.remove('selected');
            });
            if (currentEditingLi) {
                currentEditingLi.classList.remove('edit-mode');
                currentEditingLi = null;
            }
        }

        /**
         * @function editEmployee
         * @description Populates the form with employee data for editing.
         * @param {object} employee - The employee object to edit.
         */
        function editEmployee(employee) {
            editingEmployeeId = employee.id;
            document.getElementById('formTitle').textContent = 'Editar Funcion√°rio';
            document.getElementById('formButton').textContent = 'Atualizar';
            document.getElementById('cancelEditButton').style.display = 'block';
            document.getElementById('employeeName').value = employee.name || '';
            document.getElementById('employeeId').value = employee.employeeId || '';
            document.getElementById('employeeRole').value = employee.role || '';
            document.getElementById('employeeStatus').value = employee.status || 'ativo';
            // Focus on the name field for easy editing
            document.getElementById('employeeName').focus();
        }

        /**
         * @function deleteEmployee
         * @description Deletes an employee from Firestore after user confirmation.
         * @param {string} employeeId - The ID of the employee document to delete.
         * @param {string} employeeName - The name of the employee for confirmation message.
         */
        async function deleteEmployee(employeeId, employeeName) {
            const confirmed = await showModal('Confirma√ß√£o', `Tem certeza que deseja apagar ${employeeName}? Essa a√ß√£o n√£o pode ser desfeita!`, 'confirm');
            if (confirmed) {
                try {
                    const employeeDocRef = doc(db, `artifacts/${appId}/public/data/employees`, employeeId);
                    await deleteDoc(employeeDocRef);
                    await showModal('Sucesso!', 'Funcion√°rio removido da nuvem! üò¢', 'alert');
                    // No need to call loadEmployees() as onSnapshot will handle it
                } catch (error) {
                    console.error('Erro ao apagar funcion√°rio:', error);
                    await showModal('Erro ao Apagar', 'Opa, algo deu errado ao apagar! Erro: ' + error.message, 'alert');
                }
            }
        }

        /**
         * @function startInlineEdit
         * @description Converts an employee list item into an editable form.
         * @param {HTMLElement} li - The list item element to make editable.
         * @param {object} employee - The employee data.
         */
        function startInlineEdit(li, employee) {
            if (currentEditingLi) {
                // If another item is being edited, revert it first.
                const originalEmployeeData = JSON.parse(currentEditingLi.dataset.originalEmployee);
                cancelInlineEdit(currentEditingLi, originalEmployeeData);
            }
            currentEditingLi = li;
            li.classList.add('edit-mode');
            li.dataset.originalEmployee = JSON.stringify(employee); // Store original data

            let infoDiv = li.querySelector('.employee-info');
            infoDiv.innerHTML = ''; // Clear current info

            // Create input fields for inline editing
            let nameInput = document.createElement('input');
            nameInput.value = employee.name;
            nameInput.className = 'p-1 border border-gray-300 rounded-md text-sm w-full md:w-auto flex-grow mr-1';
            nameInput.placeholder = 'Nome';

            let idInput = document.createElement('input');
            idInput.value = employee.employeeId;
            idInput.className = 'p-1 border border-gray-300 rounded-md text-sm w-24 mr-1';
            idInput.placeholder = 'Matr√≠cula';

            let roleSelect = document.createElement('select');
            roleSelect.className = 'p-1 border border-gray-300 rounded-md text-sm w-28 mr-1';
            ['Coletor', 'Gari', 'Motorista'].forEach(role => {
                let option = document.createElement('option');
                option.value = role;
                option.text = role;
                if (role === employee.role) option.selected = true;
                roleSelect.appendChild(option);
            });

            let statusSelect = document.createElement('select');
            statusSelect.className = 'p-1 border border-gray-300 rounded-md text-sm w-24 mr-1';
            ['ativo', 'inativo'].forEach(status => {
                let option = document.createElement('option');
                option.value = status;
                option.text = status.charAt(0).toUpperCase() + status.slice(1);
                if (status === employee.status) option.selected = true;
                statusSelect.appendChild(option);
            });

            // Append inputs to infoDiv
            infoDiv.appendChild(nameInput);
            infoDiv.appendChild(idInput);
            infoDiv.appendChild(roleSelect);
            infoDiv.appendChild(statusSelect);

            // Create Save and Cancel icons
            let saveIcon = document.createElement('span');
            saveIcon.textContent = 'üíæ';
            saveIcon.title = 'Salvar';
            saveIcon.className = 'save-icon text-green-600 hover:text-green-800 text-lg cursor-pointer ml-2';
            saveIcon.onclick = (e) => {
                e.stopPropagation(); // Prevent li click event
                saveInlineEdit(li, employee.id, nameInput.value, idInput.value, roleSelect.value, statusSelect.value);
            };

            let cancelIcon = document.createElement('span');
            cancelIcon.textContent = 'üö´';
            cancelIcon.title = 'Cancelar';
            cancelIcon.className = 'cancel-icon text-gray-500 hover:text-gray-700 text-lg cursor-pointer ml-1';
            cancelIcon.onclick = (e) => {
                e.stopPropagation(); // Prevent li click event
                const originalData = JSON.parse(li.dataset.originalEmployee);
                cancelInlineEdit(li, originalData);
            };

            // Replace existing icons with Save and Cancel
            const existingEditIcon = li.querySelector('.edit-icon');
            const existingDeleteIcon = li.querySelector('.delete-icon');
            if (existingEditIcon) existingEditIcon.remove();
            if (existingDeleteIcon) existingDeleteIcon.remove();

            li.appendChild(saveIcon);
            li.appendChild(cancelIcon);
        }

        /**
         * @function saveInlineEdit
         * @description Saves inline edited employee data to Firestore.
         * @param {HTMLElement} li - The list item element.
         * @param {string} employeeId - The ID of the employee document.
         * @param {string} newName - The new name.
         * @param {string} newEmployeeId - The new employee ID.
         * @param {string} newRole - The new role.
         * @param {string} newStatus - The new status.
         */
        async function saveInlineEdit(li, employeeId, newName, newEmployeeId, newRole, newStatus) {
            newName = newName.trim().toUpperCase();
            newEmployeeId = newEmployeeId.trim();

            if (!newName || !newEmployeeId || !newRole) {
                await showModal('Campos Obrigat√≥rios', 'Preencha todos os campos da edi√ß√£o em linha!', 'alert');
                return;
            }

            try {
                // Check for duplicate employee ID
                const isDuplicateId = await checkDuplicateEmployeeId(newEmployeeId, employeeId);
                if (isDuplicateId) {
                    await showModal('Matr√≠cula Duplicada', 'Opa, essa matr√≠cula j√° t√° cadastrada! Tenta outra, campe√£o! üòú', 'alert');
                    return;
                }
                // Check for duplicate employee name
                const isDuplicateName = await checkDuplicateEmployeeName(newName, employeeId);
                if (isDuplicateName) {
                    await showModal('Nome Duplicado', 'Opa, esse nome j√° t√° cadastrada! Tenta outra, campe√£o! üòú', 'alert');
                    return;
                }

                const employeeDocRef = doc(db, `artifacts/${appId}/public/data/employees`, employeeId);
                await updateDoc(employeeDocRef, {
                    name: newName,
                    employeeId: newEmployeeId,
                    role: newRole,
                    status: newStatus,
                    timestamp: FieldValue.serverTimestamp()
                });
                await showModal('Sucesso!', 'Funcion√°rio atualizado na nuvem! T√° voando alto! üöÄ', 'alert');
                currentEditingLi = null; // Reset editing state
            } catch (error) {
                console.error('Erro ao salvar edi√ß√£o em linha:', error);
                await showModal('Erro ao Salvar', 'Opa, algo deu errado! Erro: ' + error.message, 'alert');
            }
        }

        /**
         * @function cancelInlineEdit
         * @description Cancels inline editing and reverts the list item to display mode.
         * @param {HTMLElement} li - The list item element.
         * @param {object} employee - The original employee data to restore.
         */
        function cancelInlineEdit(li, employee) {
            li.classList.remove('edit-mode');
            delete li.dataset.originalEmployee; // Remove stored original data

            let infoDiv = li.querySelector('.employee-info');
            // Reconstruct the display HTML for the employee
            infoDiv.innerHTML = `${getRoleIcon(employee.role)} <span class="employee-name">${employee.name}</span> <span class="employee-id-role">-${employee.employeeId} - ${employee.role}</span><span class="employee-status ${employee.status === 'inativo' ? 'text-red-500' : 'text-green-600'}"> (${employee.status.charAt(0).toUpperCase() + employee.status.slice(1)})</span>`;

            // Recreate original action icons (edit and delete)
            const saveIcon = li.querySelector('.save-icon');
            const cancelIcon = li.querySelector('.cancel-icon');
            if (saveIcon) saveIcon.remove();
            if (cancelIcon) cancelIcon.remove();

            let editIcon = document.createElement('span');
            editIcon.textContent = '‚úèÔ∏è';
            editIcon.title = 'Editar';
            editIcon.className = 'edit-icon text-blue-600 hover:text-blue-800 text-lg cursor-pointer ml-2';
            editIcon.onclick = (e) => {
                e.stopPropagation();
                startInlineEdit(li, employee);
            };

            let deleteIcon = document.createElement('span');
            deleteIcon.textContent = 'üóëÔ∏è';
            deleteIcon.title = 'Excluir';
            deleteIcon.className = 'delete-icon text-red-500 hover:text-red-700 text-lg cursor-pointer ml-1';
            deleteIcon.onclick = (e) => {
                e.stopPropagation();
                deleteEmployee(employee.id, employee.name);
            };

            li.appendChild(editIcon);
            li.appendChild(deleteIcon);
            currentEditingLi = null; // Reset editing state
        }


        /**
         * @function getRoleIcon
         * @description Returns an emoji icon based on the employee's role.
         * @param {string} role - The employee's role.
         * @returns {string} The corresponding emoji.
         */
        function getRoleIcon(role) {
            switch (role) {
                case 'Gari': return 'üßπ';
                case 'Motorista': return 'üöõ';
                case 'Coletor': return 'üóëÔ∏è';
                default: return '';
            }
        }

        /**
         * @function loadEmployees
         * @description Fetches and displays employees from Firestore based on current filters.
         * Uses onSnapshot for real-time updates.
         * @param {string} queryText - Text to search for in name, ID, or role.
         * @param {string} roleFilter - Filter by employee role.
         * @param {string} statusFilter - Filter by employee status.
         */
        function loadEmployees(queryText = '', roleFilter = '', statusFilter = '') {
            // Ensure auth is ready before attempting Firestore operations
            if (!authReady) {
                console.warn("Firestore not ready. Authentication not complete.");
                return;
            }

            const employeeListUl = document.getElementById('employeeList');
            const employeeCounterP = document.getElementById('employeeCounter');
            
            // Reference to the 'employees' collection
            const employeesRef = collection(db, `artifacts/${appId}/public/data/employees`);
            const q = query(employeesRef); // Initial query without specific where clauses for onSnapshot

            // Set up real-time listener
            onSnapshot(q, (snapshot) => {
                let employees = [];
                snapshot.forEach(doc => {
                    const employee = doc.data();
                    // Basic validation for required fields
                    if (!employee.employeeId || !employee.name || !employee.role) {
                        console.warn(`Document ${doc.id} possui campos ausentes ou inv√°lidos:`, employee);
                        return; // Skip this document if essential fields are missing
                    }
                    employees.push({
                        id: doc.id,
                        name: employee.name,
                        employeeId: employee.employeeId,
                        role: employee.role,
                        status: employee.status || 'ativo' // Default to 'ativo' if status is missing
                    });
                });

                // Apply in-memory filtering (due to Firestore query limitations and avoiding index creation issues)
                const filteredEmployees = employees.filter(employee => {
                    const lowerCaseQuery = queryText.toLowerCase();
                    const nameMatches = employee.name.toLowerCase().includes(lowerCaseQuery);
                    const idMatches = employee.employeeId.toLowerCase().includes(lowerCaseQuery);
                    const roleMatches = employee.role.toLowerCase().includes(lowerCaseQuery);
                    
                    const matchesQuery = (queryText === '' || nameMatches || idMatches || roleMatches);
                    const matchesRole = (roleFilter === '' || employee.role === roleFilter);
                    const matchesStatus = (statusFilter === '' || employee.status === statusFilter);

                    return matchesQuery && matchesRole && matchesStatus;
                });

                // Sort by employeeId in ascending order (in-memory)
                filteredEmployees.sort((a, b) => {
                    const idA = a.employeeId || '';
                    const idB = b.employeeId || '';
                    // Handle numeric part of IDs correctly (e.g., "001" vs "10")
                    const numIdA = parseInt(idA.replace(/\D/g, ''), 10) || 0;
                    const numIdB = parseInt(idB.replace(/\D/g, ''), 10) || 0;

                    if (numIdA !== numIdB) {
                        return numIdA - numIdB;
                    }
                    // Fallback to string comparison if numeric parts are identical (for cases like "A1" vs "A2")
                    return idA.localeCompare(idB);
                });

                // Update UI
                employeeCounterP.textContent = `Total de funcion√°rios na nuvem: ${filteredEmployees.length} ‚òÅÔ∏è`;
                employeeListUl.innerHTML = ''; // Clear current list

                if (filteredEmployees.length === 0) {
                    const noResultsLi = document.createElement('li');
                    noResultsLi.className = 'bg-white p-4 rounded-lg shadow-md text-center text-gray-500 italic';
                    noResultsLi.textContent = 'Nenhum funcion√°rio encontrado. Tenta de novo! üòÖ';
                    employeeListUl.appendChild(noResultsLi);
                } else {
                    filteredEmployees.forEach(employee => {
                        const li = document.createElement('li');
                        li.id = `employee-${employee.id}`; // Add a unique ID for easy access
                        li.className = `flex items-center justify-between p-4 mb-2 bg-white rounded-lg shadow-md cursor-pointer transition-all duration-200 ease-in-out hover:bg-gray-50 ${employee.status === 'inativo' ? 'opacity-80' : ''}`;
                        li.classList.toggle('inactive', employee.status === 'inativo');

                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'employee-info flex items-center flex-grow flex-wrap';
                        
                        // Role Icon
                        const roleIconSpan = document.createElement('span');
                        roleIconSpan.textContent = getRoleIcon(employee.role);
                        roleIconSpan.className = 'mr-2 text-xl';

                        // Employee Name
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'employee-name font-semibold text-gray-800 text-base mr-2';
                        nameSpan.textContent = employee.name;

                        // Employee ID and Role
                        const idRoleSpan = document.createElement('span');
                        idRoleSpan.className = 'employee-id-role text-gray-600 text-sm break-all mr-2';
                        idRoleSpan.textContent = `(${employee.employeeId} - ${employee.role})`;

                        // Employee Status
                        const statusSpan = document.createElement('span');
                        statusSpan.className = `employee-status text-sm italic ${employee.status === 'inativo' ? 'text-red-500' : 'text-green-600'}`;
                        statusSpan.textContent = `(${employee.status.charAt(0).toUpperCase() + employee.status.slice(1)})`;

                        infoDiv.appendChild(roleIconSpan);
                        infoDiv.appendChild(nameSpan);
                        infoDiv.appendChild(idRoleSpan);
                        infoDiv.appendChild(statusSpan);
                        
                        // Action Icons Container
                        const actionIconsDiv = document.createElement('div');
                        actionIconsDiv.className = 'flex-shrink-0 flex items-center ml-auto';

                        // Edit Icon
                        const editIcon = document.createElement('span');
                        editIcon.textContent = '‚úèÔ∏è'; // Pencil emoji
                        editIcon.title = 'Editar';
                        editIcon.className = 'edit-icon text-blue-600 hover:text-blue-800 text-lg cursor-pointer ml-2';
                        editIcon.onclick = (e) => {
                            e.stopPropagation(); // Prevent li click event from firing
                            startInlineEdit(li, employee);
                        };

                        // Delete Icon
                        const deleteIcon = document.createElement('span');
                        deleteIcon.textContent = 'üóëÔ∏è'; // Wastebasket emoji
                        deleteIcon.title = 'Excluir';
                        deleteIcon.className = 'delete-icon text-red-500 hover:text-red-700 text-lg cursor-pointer ml-1';
                        deleteIcon.onclick = (e) => {
                            e.stopPropagation(); // Prevent li click event from firing
                            deleteEmployee(employee.id, employee.name);
                        };

                        actionIconsDiv.appendChild(editIcon);
                        actionIconsDiv.appendChild(deleteIcon);

                        li.appendChild(infoDiv);
                        li.appendChild(actionIconsDiv);

                        // Click handler for selecting an employee (to populate the main form)
                        li.onclick = (e) => {
                            // Only select if not in inline edit mode and not clicking action icons
                            if (!li.classList.contains('edit-mode') && 
                                e.target !== editIcon && e.target !== deleteIcon &&
                                e.target.parentElement !== actionIconsDiv) {
                                
                                document.querySelectorAll('#employeeList li').forEach(item => {
                                    item.classList.remove('selected', 'border-2', 'border-blue-500', 'bg-blue-50');
                                });
                                li.classList.add('selected', 'border-2', 'border-blue-500', 'bg-blue-50');
                                editEmployee(employee);
                                document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
                            }
                        };
                        employeeListUl.appendChild(li);
                    });
                }
            }, (error) => {
                console.error('Erro ao carregar lista em tempo real:', error);
                let errorMessage = error.message || 'Erro desconhecido';
                if (error.code === 'permission-denied') {
                    errorMessage = 'Voc√™ n√£o tem permiss√£o para acessar esses dados. Verifique as regras de seguran√ßa do Firestore.';
                } else if (error.code === 'failed-precondition') {
                    errorMessage = '√çndice do Firestore ausente. Acesse o Firebase Console e crie um √≠ndice composto para "employees" com "employeeId" (asc) e "name" (asc).';
                }
                showModal('Erro ao Carregar', 'Opa, algo deu errado ao carregar a lista: ' + errorMessage, 'alert');
            });
        }

        /**
         * @function searchEmployees
         * @description Triggers a reload of employees with the current search query and filters.
         * Called on 'keyup' for the search input.
         */
        function searchEmployees() {
            const query = document.getElementById('searchInput').value.trim();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            loadEmployees(query, roleFilter, statusFilter);
        }

        /**
         * @function filterByRole
         * @description Triggers a reload of employees with the current role filter.
         * Called on 'change' for the role select.
         */
        function filterByRole() {
            searchEmployees(); // Reuse searchEmployees as it gathers all filters
        }

        /**
         * @function filterByStatus
         * @description Triggers a reload of employees with the current status filter.
         * Called on 'change' for the status select.
         */
        function filterByStatus() {
            searchEmployees(); // Reuse searchEmployees as it gathers all filters
        }

        /**
         * @function listAllEmployees
         * @description Resets all search and filter inputs and reloads all employees.
         */
        function listAllEmployees() {
            document.getElementById('searchInput').value = '';
            document.getElementById('roleFilter').value = '';
            document.getElementById('statusFilter').value = '';
            loadEmployees('', '', ''); // Load all employees
        }

        // Initialize Firebase and set up authentication
        async function initializeFirebaseAndAuth() {
            try {
                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Check for initial auth token provided by the environment
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `ID do Usu√°rio: ${userId}`;
                        authReady = true; // Set flag to true once authentication is confirmed
                        console.log("Auth state changed. User ID:", userId);
                        loadEmployees(); // Load employees only after authentication is ready
                    } else {
                        userId = null;
                        document.getElementById('userIdDisplay').textContent = `ID do Usu√°rio: N√£o autenticado`;
                        authReady = false;
                        console.log("Auth state changed. No user.");
                        // Handle unauthenticated state if necessary (e.g., clear list)
                        document.getElementById('employeeList').innerHTML = '<li class="bg-white p-4 rounded-lg shadow-md text-center text-gray-500 italic">Por favor, autentique-se para ver os funcion√°rios.</li>';
                        document.getElementById('employeeCounter').textContent = 'Total de funcion√°rios na nuvem: 0 ‚òÅÔ∏è';
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or signing in:", error);
                await showModal('Erro de Inicializa√ß√£o', 'Opa, n√£o consegui iniciar o sistema! Erro: ' + error.message, 'alert');
            }
        }

        // Call the initialization function when the window loads
        window.onload = initializeFirebaseAndAuth;

        // Make functions globally accessible for inline HTML event handlers
        window.saveEmployee = saveEmployee;
        window.cancelEdit = cancelEdit;
        window.editEmployee = editEmployee;
        window.deleteEmployee = deleteEmployee;
        window.searchEmployees = searchEmployees;
        window.filterByRole = filterByRole;
        window.filterByStatus = filterByStatus;
        window.listAllEmployees = listAllEmployees;
        window.showModal = showModal; // Expose modal for debugging if needed
        window.startInlineEdit = startInlineEdit;
        window.saveInlineEdit = saveInlineEdit;
        window.cancelInlineEdit = cancelInlineEdit;

        // IMPORTANT: The `loadEmployees` function is now called inside `onAuthStateChanged` to ensure Firestore is ready.
        // It should NOT be called directly here.
    </script>
</body>
</html>
